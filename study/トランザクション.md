# トランザクション

トランザクションとは、データベースにおける一連の操作をまとめて1つの単位として扱うことを指します。
トランザクションは、データベースの整合性を保つために重要な役割を果たします。トランザクションは、以下の4つの特性を持っています。  
※ ACID特性と呼ばれます
- 原子性 (Atomicity): トランザクション内のすべての操作が成功するか、すべてが失敗するかのいずれかであることを保証します。部分的な成功は許されません。
- 一貫性 (Consistency): トランザクションが完了した後、データベースは一貫した状態に保たれます。トランザクションが開始される前と後で、データの整合性が保たれることを保証します。
- 隔離性 (Isolation): 同時に実行されるトランザクションは互いに影響を与えないように隔離されます。これにより、同時実行性の問題が回避されます。
- 持続性 (Durability): トランザクションが成功した場合、その結果は永続的に保存され、システム障害が発生しても失われることはありません。
- https://e-words.jp/w/ACID%E7%89%B9%E6%80%A7.html


トランザクションを開始するときは、データベースに対してロックを取得します。

トランザクションの課題
- ダーティリード（他トランザクションの未確定データを読んでしまう）
- ノンリピータブルリード（同じデータを2回読み込んだときに、異なる値が返る）
- ファントムリード（条件に一致する行がトランザクション中に変わる）
- ロストアップデート（同じデータを同時に更新して一方の更新が失われる）
- デッドロック (複数のトランザクションが互いにロックを待ち合う状態で、どちらのトランザクションも進行できなくなる現象)


分離レベル: Isolationに関する概念
- READ_UNCOMMITTED: トランザクションの未確定データを外部から読み取ることができる
- READ_COMMITTED: トランザクションが完了するまで、そのデータを外部から読み取ることができない
- REPEATABLE_READ: トランザクション内で一度読み取ったデータは、トランザクションが完了するまで更新されない
- SERIALIZABLE: トランザクションが完全に隔離され、他のトランザクションと同時に実行されない

MySQL(InnoDB)のデフォルトはREPEATABLE_READ
https://dev.mysql.com/doc/refman/8.0/ja/innodb-transaction-isolation-levels.html

PostgreSQLのデフォルトはREAD_COMMITTED


## コマンド

- BEGIN: トランザクションの開始
- COMMIT: トランザクションの確定
- ROLLBACK: トランザクションの取り消し

```mysql
-- 設定
CREATE DATABASE transaction_test;
SHOW DATABASES;
use transaction_test;
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    age INT NOT NULL
);
SHOW TABLES;


-- 例
BEGIN;

SELECT count(*) FROM users;
INSERT INTO users (name, age) VALUES ('John', 25);

SELECT count(*) FROM users;
-- COMMIT or ROLLBACK
COMMIT;
```

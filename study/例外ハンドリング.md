# 例外ハンドリング

SpringBootではアプリケーション全体の例外をハンドリングするための仕組みが用意されています。  
※ 大抵のフレームワークにはこのような仕組みが用意されています。


一番簡単な例
```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    // 任意の例外をハンドリング
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<String> handleNotFound(ResourceNotFoundException ex) {
        return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body("リソースが見つかりません: " + ex.getMessage());
    }

    // 予期しない例外をまとめてキャッチ
    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> handleException(Exception ex) {
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body("システムエラーが発生しました");
    }
    
}

```

- `@ControllerAdvice`はコントローラーからレスポンスが返される前に共通して実行される処理を定義するためのアノテーション
- `@RestControllerAdvice`は`@ControllerAdvice`と`@ResponseBody`を組み合わせたもので、レスポンスのオブジェクトが自動的にJSONに変換される
- `@ExceptionHandler`は特定の例外をキャッチして処理するためのアノテーション
   - メソッドの引数には例外の型を指定する
- `ResponseEntity`はHTTPレスポンスをカスタマイズするためのクラスで、ステータスコードやヘッダー、ボディを設定できるクラス

※ Advice(アドバイス)は、特定のタイミング（前処理・後処理・例外処理など）に実行される“補助処理”

画面を返す場合の例
```java
@ControllerAdvice
public class ScreenExceptionHandler {

    @ExceptionHandler(FriendNotFoundException.class)
    public ModelAndView handleNotFound(FriendNotFoundException ex) {
        ModelAndView mv = new ModelAndView("error/notfound");
        mv.addObject("message", ex.getMessage());
        return mv;
    }

    @ExceptionHandler(Exception.class)
    public ModelAndView handleError(Exception ex) {
        ModelAndView mv = new ModelAndView("error/500");
        mv.addObject("message", "システムエラーが発生しました");
        return mv;
    }
}
```

restでクラスを継承する場合
```java
@RestControllerAdvice
public class RestGlobalExceptionHandler extends ResponseEntityExceptionHandler {

    @ExceptionHandler({NotFoundException.class})
    public ResponseEntity<Object> handleNotFoundException(NotFoundException ex, WebRequest request) {
        // リクエストのBodyのセット
        String path = ((ServletWebRequest) request).getRequest().getRequestURI();
        ApiError apiError = new ApiError(ex.getCode(), ex.getMessage(), path);

        // リクエストヘッダーの作成
        HttpHeaders httpHeaders = new HttpHeaders();

        return handleExceptionInternal(ex, apiError, httpHeaders, HttpStatus.NOT_FOUND, request);
    }

    @Override
    protected ResponseEntity<Object> handleExceptionInternal(
            Exception ex,
            Object body,
            HttpHeaders headers,
            HttpStatus status,
            WebRequest request
    ) {
        // リクエストのBodyのセット
        String path = ((ServletWebRequest) request).getRequest().getRequestURI();
        ApiError apiError = new ApiError(0, ex.getMessage(), path);

        return super.handleExceptionInternal(ex, apiError, headers, status, request);
    }
}
```
